# School_Photo_Finder_diary_20250630

## 作業概要
本日は、中断していたPythonライブラリのインストールから作業を再開し、主要機能であるウェブサイトへの自動ログイン、展示室・フォルダ選択、そして顔認証による写真の自動選択・追加機能の実装を進めました。

## 課題と解決策

### 1. `dlib`のインストール問題
- **課題**: `pip install -r requirements.txt`実行時に`dlib`のビルドエラー（C++コンパイラ関連）が継続して発生しました。Visual Studio Build ToolsのインストールやPC再起動後も解決しませんでした。
- **試行と結果**:
    - `cmake`の存在確認: 導入済みであることを確認。
    - `vcvarsall.bat`による環境設定: パスの問題で複数回失敗。
    - **解決策**: `dlib`のコンパイル済みホイールファイル（.whl）を直接インストールすることで、`dlib`自体のインストールは成功しました。

### 2. `face_recognition_models`の認識問題
- **課題**: `dlib`のインストール後も`face_recognition`が`face_recognition_models`を見つけられないというエラーが継続しました。
- **試行と結果**:
    - `face_recognition_models`をGitHubから直接インストール: エラーが解消されず。
    - `face-recognition`と`face_recognition_models`のアンインストール、キャッシュクリア、`requirements.txt`からの再インストール: `dlib`のビルドエラーが再発し、`face_recognition_models`の問題も解決せず。
    - **最終的な状況**: `dlib`のホイールインストールと`face-recognition`の`--no-deps`オプションでのインストールを試みる直前で作業が中断となりました。この問題は未解決です。

### 3. ログイン機能の実装とデバッグ
- **課題**: `main.py`の初回実行時、ログインボタンの要素特定に失敗しました。また、要素特定後も`element click intercepted`エラーが発生しました。
- **解決策**:
    - ユーザーから提供された正確なXPath情報に基づき、ログインID、パスワード入力欄、ログインボタンのXPathを`main.py`に反映しました。
    - `element click intercepted`エラーに対しては、`EC.element_to_be_clickable`による待機と、JavaScript (`driver.execute_script("arguments[0].click();", element)`) を用いたクリック処理を導入することで解決しました。
- **結果**: 自動ログイン機能は正常に動作することを確認しました。

### 4. 展示室・フォルダ選択機能の実装
- **課題**: ログイン後の展示室選択、および日付選択後のフォルダ選択の自動化が必要でした。
- **解決策**: ユーザーから提供されたHTML構造情報に基づき、以下の処理を実装しました。
    - `roomList`クラスを持つテーブルから「購入済」以外の展示室を抽出し、ユーザーに選択させるロジック。
    - 選択された展示室のリンクへの自動遷移。
    - 「写真はこちら」ボタンのクリック。
    - 日付選択ボタン（`a.active`）のクリック。
    - `class="open"`を持つ`<a>`タグからフォルダ（アルバム）を抽出し、ユーザーに選択させるロジック。
    - 選択されたフォルダのリンクへの自動遷移。
- **結果**: 展示室およびフォルダの自動選択・遷移機能は実装されました。

### 5. 写真の顔認証と自動追加機能の実装
- **課題**: アルバムページに表示される写真の画像URLの取得方法と、「ご注文候補に追加」ボタンの特定、そして顔認証ロジックの組み込みが必要でした。
- **解決策**:
    - 写真の画像URLが`div.image-frame`の`background-image`スタイルに格納されていることを特定し、URLを抽出するロジックを実装しました。
    - `requests`ライブラリを使用して画像URLから画像をダウンロードする`download_image`関数を実装しました。
    - `face_recognition`と`numpy`をインポートし、ダウンロードした画像から顔を検出し、ターゲットの顔エンコーディングと比較するロジックを実装しました。
    - 顔が一致した場合、対応する「ご注文候補に追加」ボタン（`a.add`）をJavaScriptでクリックするロジックを実装しました。
- **課題（再発）**: `photo_button_xpath`の構文エラーが発生しましたが、文字列のエスケープを修正することで解決しました。
- **未解決の課題**: `face_recognition_models`の認識問題が解決していないため、顔認証機能の動作確認はできていません。

## 今後の課題
- `dlib`および`face_recognition`のインストールに関する根本的な問題の解決。特に`face_recognition_models`が正しく認識されない問題。
- 顔認証機能の動作確認とデバッグ。
- ページネーションへの対応（現在、最初のページの写真のみを処理）。
- エラーハンドリングの強化。

## 感想
`dlib`のインストール問題は非常に手強く、様々なアプローチを試みましたが、最終的な解決には至りませんでした。Pythonの環境構築の難しさを改めて痛感しました。しかし、ウェブサイトの要素特定や自動操作のロジックは着実に組み込むことができました。次回は、`dlib`と`face_recognition`のインストール問題を確実に解決し、顔認証機能の動作確認に進みたいです。
